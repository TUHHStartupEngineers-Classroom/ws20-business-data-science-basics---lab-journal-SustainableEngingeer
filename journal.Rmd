---
title: "Journal (reproducible report)"
author: "Nils Stamm"
date: "2020-11-05"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```


# My second Assignmend -- Data Acquisition

## WEB SCRAPING

Last compiled: `r Sys.Date()`

The following data are scraped from
[Radon Bikes](https://www.radon-bikes.de) (Last Update: 20/12/01)

The bike manufacturer has the following product families
```{r}
bike_family_tbl <- readRDS("data/bike_family_tbl.rds")

bike_family_tbl
```

Each of them is on after another divided into two categories
```{r}
bike_category_tbl <- readRDS("data/bike_category_tbl.rds")

bike_category_tbl
```


The data of the first category `hardtail` was scraped with

```{r eval=FALSE, echo=TRUE} 
# 3 COLLECT BIKE DATA ----
library(tidyverse) # Main Package - Loads dplyr, purrr, etc.
library(rvest)     # HTML Hacking & Web Scraping
library(stringi)   # character string/text processing

url_category <- "https://www.radon-bikes.de/mountainbike/hardtail/bikegrid/"
html_category <- read_html(url_category)


# 3.1 Bike names  
bike_names_tbl <- html_category %>%
  
  html_nodes(css = ".a-heading--small") %>%   # nodes
  html_text() %>%
  str_extract(pattern = "(?<=\\s)[A-Z].*(?=\\n)") %>%
  na.omit() %>%
  
  # Convert vector to tibble
  enframe(name = "product.id", value = "model")
  

# 3.2 Prices
bike_prices_tbl <- html_category %>%
  
  html_nodes(css = ".m-bikegrid__price--active") %>%   # nodes
  html_text() %>%
  str_extract(pattern = "\\d+") %>%
  na.omit() %>%
  

# Convert vector to tibble
  enframe(name = "price.id", value = "price_EUR")
``` 


The Data was cleaned and merged as shown below

```{r eval=FALSE, echo=TRUE} 
# MERGE DATA --------------------------------------------------------------

data_tbl <- left_join(bike_names_tbl,bike_prices_tbl, by = c("product.id" = "price.id"))
  
# Cleaning
data_cleaned_tbl <- data_tbl %>%
  subset(!str_detect(model, "Frameset")) %>%
  subset(!str_detect(model, "NEW"))

# Add information and reorder
data_cleaned_compl_tabl <- data_cleaned_tbl %>%
  cbind(family = bike_family_tbl[[1,2]]) %>%
  cbind(category = bike_category_tbl[[1,2]]) %>%
  select(product.id, family, category, model, price_EUR)


write_rds(data_cleaned_compl_tabl, "data_cleaned_compl_tabl.rds")
``` 

### Result

```{r}
families <- readRDS("data_cleaned_compl_tabl.rds")

families
```





# My first Assignmend

Last compiled: `r Sys.Date()`


## Revenue analysis by state

```{r, fig.width=10, fig.height=7}
  sales_by_state_tbl <- readRDS("data/sales_by_state_tbl.rds")

  library(ggrepel)
  sales_by_state_tbl %>%
  ggplot(aes(x = location_state, y = sales)) +
    
  geom_col(fill = "#2DC6D6") + # Use geom_col for a bar plot
  geom_label_repel(aes(label = sales_text)) + # Adding labels to the bars
  
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                      decimal.mark = ",", 
                                                      prefix = "", 
                                                      suffix = " €")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    
  labs(
      title    = "Revenue by state",
      subtitle = "in Germany",
      x = "State", # Override defaults for x and y
      y = "Revenue")
```  
  
  
## Revenue analysis over years per state
  
```{r, fig.width=10, fig.height=7} 
  sales_by_year_state_tbl <- readRDS("data/sales_by_year_state_tbl.rds")  

  sales_by_year_state_tbl %>%
  ggplot(aes(x = year, y = sales, fill = location_state)) +
    
  geom_col() + # Run up to here to get a stacked bar plot
  geom_smooth(method = "lm", se = FALSE) + # Adding a trendline
    
  facet_wrap(~ location_state) +
    
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                      decimal.mark = ",", 
                                                      prefix = "", 
                                                      suffix = " €")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    
  labs(
      title = "Revenue by year and state",
      subtitle = "in Germany",
      fill = "State") # Changes the legend name
```